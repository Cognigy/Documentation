name: sync

# Do not automatically trigger this pipeline if a normal commit + push
# occurs. We will trigger this pipeline based on a schedule.
trigger: none

schedules:
  - cron: "0 0 * * *"
    displayName: Daily midnight sync
    branches:
      include:
        - main

resources:
  - repo: self

pool:
  vmImage: ubuntu-20.04

stages:
  - stage: Sync
    displayName: Sync Azure DevOps with GitHub
    jobs:
      - job:
        displayName: Sync Azure DevOps with GitHub
        steps:
          - checkout: self
            persistCredentials: "true"
            clean: "true"

          - task: InstallSSHKey@0
            inputs:
              knownHostsEntry: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
              sshPublicKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDo/VKBdXyf3fgCSy8DBPeZSyc3s+yoHKzniaoeJtbmaGfiF0/eqk0HSbYXCJcOEWsU33Lw/fpxI1cZukJcYtohhT/cnb0SBPAtTnVGoHVT1+jKmKRUHl+POW7Wpld3Lp7X0eU5087xb6cBwOOVmASYPbydzz+UKXHbNYHSXMtmAgPbKTRrlrQEYNVhYm5HGmv4kyXf7A7mu8+vDCw8cW/ggTJxC/wIzmvRcRY1L+fRIj/ptpA+3UU9cc+vvzkMgrVbANmFreBwg13qE2OacFrnueTysr/DDHE6kaJ88UT2gIqC6a3Hf8PojgmZmq5tjQUGL+yVDcNzSi35KRWNvr7dDhfayy/HT9R0OY9KxNjkUaGWhWLxmCS0GLSf8/ncL0Y455MDQn8fA4lX7UWUcGwZiAmjBIZsv7h/wkNzVrjLgvOBeU4VNPWzfu6TiG6mnfiqGHXL2QEpqDSPXE77E/jYEL1jc04qOS415ny7eylYi5yoP+ZL4R+ECmmdvn5+hrs= benni@benni-ThinkPad-X1-Extreme-2nd
              sshKeySecureFile: github-deploy

          - script: |
              git config --global user.email "azure-pipeline@cognigy.com"
              git config --global user.name "Azure Pipelines Bot"

              git remote add github git@github.com:Cognigy/Documentation.git
              git fetch github
              git merge github/main --no-edit
            displayName: Pull main from GitHub and merge

          - script: |
              git push origin main
            displayName: Push changes to Azure DevOps